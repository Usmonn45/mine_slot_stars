<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Космический сборщик</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        :root {
            --bg-color-dark: #0A0A23;
            --bg-color-light: #1B263B;
            --text-color: #fff;
            --score-color: #00FF00;
            --lives-color: #FFD700;
            --gameover-color: #ff4d4d;
            --button-bg: #1E90FF;
            --button-hover-bg: #4169E1;
            --overlay-bg: rgba(0, 0, 0, 0.9);
            --shield-color: #00FFFF;
            --progress-bg: rgba(255, 255, 255, 0.2);
            --progress-fill: #00FFFF;
        }

        body {
            margin: 0;
            padding: 0;
            background: linear-gradient(to bottom, var(--bg-color-dark) 0%, var(--bg-color-light) 100%);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            font-family: 'Press Start 2P', cursive, Arial, sans-serif;
            color: var(--text-color);
            overflow: hidden;
            position: relative;
        }

        @import url('https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap');

        canvas {
            border: 3px solid #4A4AFF;
            border-radius: 10px;
            background: #000;
            display: block;
            touch-action: none;
            box-shadow: 0 0 20px rgba(74, 74, 255, 0.3);
        }

        #score, #lives, #level {
            position: absolute;
            font-size: 14px;
            color: var(--text-color);
            z-index: 10;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.8);
            padding: 8px 12px;
            background: rgba(0, 0, 0, 0.7);
            border-radius: 8px;
            border: 1px solid #4A4AFF;
        }
        #score { top: 15px; left: 15px; color: var(--score-color); }
        #lives { top: 15px; right: 15px; color: var(--lives-color); }
        #level { top: 55px; left: 15px; color: #FF69B4; }

        #shieldProgress {
            position: absolute;
            bottom: 15px;
            left: 50%;
            transform: translateX(-50%);
            width: 200px;
            height: 10px;
            background: var(--progress-bg);
            border-radius: 5px;
            overflow: hidden;
            z-index: 10;
            display: none;
            border: 1px solid var(--shield-color);
        }
        #shieldFill {
            height: 100%;
            background: var(--progress-fill);
            width: 0;
            transition: width 0.2s ease;
        }

        .overlay-screen {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: var(--overlay-bg);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
            z-index: 20;
            display: none;
            padding: 20px;
            animation: fadeIn 0.5s ease-in-out;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .overlay-screen h2 {
            font-size: 24px;
            margin-bottom: 25px;
            color: var(--gameover-color);
            text-shadow: 3px 3px 6px rgba(0, 0, 0, 0.7);
            line-height: 1.4;
            animation: pulse 1.5s infinite;
        }

        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }

        .overlay-screen p {
            font-size: 14px;
            margin-bottom: 20px;
            line-height: 1.6;
            color: #ccc;
        }
        .overlay-screen button {
            background: var(--button-bg);
            color: var(--text-color);
            border: none;
            padding: 15px 25px;
            font-size: 14px;
            cursor: pointer;
            border-radius: 8px;
            margin: 8px;
            transition: all 0.3s ease;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
            font-family: 'Press Start 2P', cursive, Arial, sans-serif;
            border: 2px solid transparent;
        }
        .overlay-screen button:hover {
            background: var(--button-hover-bg);
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.4);
        }

        #startScreen h2 { 
            color: var(--score-color); 
            font-size: 28px;
            margin-bottom: 30px;
        }

        #controls {
            display: flex;
            justify-content: space-between;
            width: 100%;
            max-width: 400px;
            margin-top: 20px;
            position: relative;
            z-index: 10;
            padding: 0 20px;
        }
        .control-button {
            background: linear-gradient(145deg, #1E90FF, #0066CC);
            color: white;
            border: none;
            padding: 20px;
            font-size: 20px;
            cursor: pointer;
            border-radius: 50%;
            width: 70px;
            height: 70px;
            display: flex;
            justify-content: center;
            align-items: center;
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.4);
            user-select: none;
            -webkit-tap-highlight-color: transparent;
            border: 2px solid #4A4AFF;
            transition: all 0.1s ease;
        }
        .control-button:active {
            background: linear-gradient(145deg, #0066CC, #1E90FF);
            transform: scale(0.95);
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.3);
        }

        #pauseButton {
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(255, 255, 255, 0.2);
            color: var(--text-color);
            border: none;
            padding: 10px 15px;
            font-size: 12px;
            cursor: pointer;
            border-radius: 5px;
            z-index: 15;
            display: none;
            font-family: 'Press Start 2P', cursive, Arial, sans-serif;
            border: 1px solid #4A4AFF;
        }
        #pauseButton:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        .floating-score {
            position: absolute;
            font-size: 16px;
            color: var(--score-color);
            opacity: 1;
            transition: all 0.8s ease-out;
            pointer-events: none;
            z-index: 10;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.8);
            font-family: 'Press Start 2P', cursive, Arial, sans-serif;
        }

        .stars {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 1;
        }
    </style>
</head>
<body>
    <div class="stars" id="stars"></div>

    <div id="score">ОЧКИ: 0</div>
    <div id="lives">ЖИЗНИ: 3</div>
    <div id="level">УРОВЕНЬ: 1</div>
    <button id="pauseButton" onclick="pauseGame()">ПАУЗА</button>

    <canvas id="gameCanvas"></canvas>

    <div id="startScreen" class="overlay-screen">
        <h2>КОСМИЧЕСКИЙ СБОРЩИК</h2>
        <p>Собирай кристаллы (+5 очков), редкие кристаллы (+10 очков)</p>
        <p>Избегай метеоритов и астероидов!</p>
        <p>Собирай бонусы для щита или ускорения</p>
        <p>Достигай новых уровней для большего вызова!</p>
        <button onclick="startGame()">НАЧАТЬ ИГРУ</button>
    </div>

    <div id="gameOverScreen" class="overlay-screen">
        <h2>ИГРА ОКОНЧЕНА!</h2>
        <p id="finalScoreDisplay"></p>
        <p id="finalLevelDisplay"></p>
        <button onclick="restartGame()">ИГРАТЬ СНОВА</button>
        <button id="submitScoreButton" onclick="submitScore()">ОТПРАВИТЬ РЕКОРД</button>
    </div>

    <div id="pauseScreen" class="overlay-screen">
        <h2>ПАУЗА</h2>
        <button onclick="resumeGame()">ПРОДОЛЖИТЬ</button>
        <button onclick="restartGame()">ЗАНОВО</button>
    </div>

    <div id="controls">
        <button class="control-button" id="leftButton">◀</button>
        <button class="control-button" id="rightButton">▶</button>
    </div>

    <div id="shieldProgress">
        <div id="shieldFill"></div>
    </div>

    <script>
        const tg = window.Telegram.WebApp;
        tg.expand();
        tg.ready();

        // --- DOM Элементы ---
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        const starsContainer = document.getElementById('stars');
        const scoreElement = document.getElementById('score');
        const livesElement = document.getElementById('lives');
        const levelElement = document.getElementById('level');
        const startScreen = document.getElementById('startScreen');
        const gameOverScreen = document.getElementById('gameOverScreen');
        const pauseScreen = document.getElementById('pauseScreen');
        const finalScoreDisplay = document.getElementById('finalScoreDisplay');
        const finalLevelDisplay = document.getElementById('finalLevelDisplay');
        const submitScoreButton = document.getElementById('submitScoreButton');
        const pauseButton = document.getElementById('pauseButton');
        const controlsDiv = document.getElementById('controls');
        const leftButton = document.getElementById('leftButton');
        const rightButton = document.getElementById('rightButton');
        const shieldProgress = document.getElementById('shieldProgress');
        const shieldFill = document.getElementById('shieldFill');

        // --- Константы Игры ---
        const GAME_STATE = {
            START: 'start',
            PLAYING: 'playing',
            PAUSED: 'paused',
            GAME_OVER: 'gameOver'
        };
        
        const SHIP_SPEED_BASE = 7; // Увеличена скорость для лучшей отзывчивости
        const OBJECT_SPAWN_RATE_BASE = 0.04; // Чуть чаще спавн
        const OBJECT_SPEED_CRYSTAL = 3;
        const OBJECT_SPEED_RARE_CRYSTAL = 3.5;
        const OBJECT_SPEED_BONUS = 2.5;
        const OBJECT_SPEED_METEOR = 4;
        const OBJECT_SPEED_ASTEROID = 3.8; // Новый тип
        const SHIELD_DURATION_FRAMES = 450; // Дольше щит
        const SPEED_BOOST_DURATION_FRAMES = 300; // Новый бонус ускорения
        const HIT_FLASH_DURATION_FRAMES = 15;
        const SCORE_CRYSTAL = 5;
        const SCORE_RARE_CRYSTAL = 10; // Новый тип кристалла
        const SHIP_WIDTH = 50;
        const SHIP_HEIGHT = 30;
        const CRYSTAL_SIZE = 25;
        const RARE_CRYSTAL_SIZE = 30;
        const METEOR_SIZE = 35;
        const ASTEROID_SIZE = 40; // Новый
        const BONUS_SIZE = 28;
        const TOUCH_MOVE_SENSITIVITY = 0.18; // Лучшая чувствительность
        const LEVEL_UP_SCORE = 100; // Очки для уровня

        // --- Игровые Переменные ---
        let currentGameState = GAME_STATE.START;
        let score = 0;
        let lives = 3;
        let level = 1;
        let objects = [];
        let ship = { x: 0, y: 0, width: SHIP_WIDTH, height: SHIP_HEIGHT, speed: SHIP_SPEED_BASE };
        let shieldActive = false;
        let shieldTimer = 0;
        let speedBoostActive = false;
        let speedBoostTimer = 0;
        let hitFlashTimer = 0;
        let difficulty = 1;
        let keys = {};
        let touchStartX = 0;
        let animationFrameId;
        let floatingScores = [];
        let stars = [];
        let audioCtx; // Для простых звуков

        // --- Инициализация аудио ---
        function initAudio() {
            if (!audioCtx) {
                audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            }
        }

        function playSound(frequency, duration, type = 'sine') {
            if (!audioCtx) return;
            const oscillator = audioCtx.createOscillator();
            const gainNode = audioCtx.createGain();
            oscillator.connect(gainNode);
            gainNode.connect(audioCtx.destination);
            oscillator.frequency.value = frequency;
            oscillator.type = type;
            gainNode.gain.value = 0.1;
            oscillator.start();
            setTimeout(() => {
                oscillator.stop();
            }, duration);
        }

        // --- Создание звездного фона с улучшениями ---
        function createStars() {
            stars = [];
            for (let i = 0; i = 150; i++) { // Больше звезд
                stars.push({
                    x: Math.random() * canvas.width,
                    y: Math.random() * canvas.height,
                    size: Math.random() * 2 + 1,
                    speed: Math.random() * 1.5 + 0.5, // Разная скорость
                    brightness: Math.random() * 0.5 + 0.5 // Для мерцания
                });
            }
        }

        function drawStars() {
            for (const star of stars) {
                ctx.fillStyle = `rgba(255, 255, 255, ${star.brightness * (Math.sin(Date.now() / 1000) * 0.2 + 0.8)})`;
                ctx.beginPath();
                ctx.arc(star.x, star.y, star.size, 0, Math.PI * 2);
                ctx.fill();
                
                // Движение звезд
                star.y += star.speed;
                if (star.y > canvas.height) {
                    star.y = 0;
                    star.x = Math.random() * canvas.width;
                }
            }
        }

        // --- Улучшенные функции рисования игровых объектов ---
        function drawShip() {
            const centerX = ship.x + ship.width / 2;
            const centerY = ship.y + ship.height / 2;
            
            // Мигание при попадании
            if (hitFlashTimer > 0 && hitFlashTimer % 3 === 0) {
                return;
            }

            // Основной корпус корабля с градиентом
            const shipGradient = ctx.createLinearGradient(ship.x, ship.y, ship.x + ship.width, ship.y + ship.height);
            shipGradient.addColorStop(0, shieldActive ? '#4A4AFF' : '#00AAFF');
            shipGradient.addColorStop(1, shieldActive ? '#0000FF' : '#0066FF');
            ctx.fillStyle = shipGradient;
            ctx.beginPath();
            ctx.moveTo(centerX, ship.y);
            ctx.lineTo(ship.x + ship.width, ship.y + ship.height);
            ctx.lineTo(ship.x, ship.y + ship.height);
            ctx.closePath();
            ctx.fill();

            // Детали корабля
            ctx.fillStyle = '#FFAA00';
            ctx.beginPath();
            ctx.arc(centerX, centerY - 5, 8, 0, Math.PI * 2);
            ctx.fill();

            // Огни двигателя с анимацией
            const engineSize = 4 + Math.sin(Date.now() / 100) * 1;
            ctx.fillStyle = '#FF4400';
            ctx.beginPath();
            ctx.arc(centerX - 10, ship.y + ship.height - 5, engineSize, 0, Math.PI * 2);
            ctx.arc(centerX + 10, ship.y + ship.height - 5, engineSize, 0, Math.PI * 2);
            ctx.fill();

            // Щит с улучшенной анимацией
            if (shieldActive) {
                const shieldRadius = ship.width / 1.3 + Math.sin(Date.now() / 200) * 2;
                ctx.strokeStyle = 'rgba(0, 255, 255, 0.6)';
                ctx.lineWidth = 3;
                ctx.beginPath();
                ctx.arc(centerX, centerY, shieldRadius, 0, Math.PI * 2);
                ctx.stroke();
                
                ctx.strokeStyle = 'rgba(0, 255, 255, 0.3)';
                ctx.lineWidth = 1;
                ctx.beginPath();
                ctx.arc(centerX, centerY, shieldRadius + 5, 0, Math.PI * 2);
                ctx.stroke();
            }

            // Эффект ускорения
            if (speedBoostActive) {
                ctx.strokeStyle = 'rgba(255, 165, 0, 0.5)';
                ctx.lineWidth = 2;
                ctx.beginPath();
                ctx.moveTo(centerX - 15, ship.y + ship.height);
                ctx.lineTo(centerX - 20, ship.y + ship.height + 10);
                ctx.moveTo(centerX + 15, ship.y + ship.height);
                ctx.lineTo(centerX + 20, ship.y + ship.height + 10);
                ctx.stroke();
            }
        }

        function drawCrystal(x, y, size, isRare = false) {
            // Основной кристалл с градиентом
            const crystalGradient = ctx.createRadialGradient(x + size/2, y + size/2, 0, x + size/2, y + size/2, size/2);
            crystalGradient.addColorStop(0, isRare ? '#FF00FF' : '#00FF88');
            crystalGradient.addColorStop(1, isRare ? '#AA00AA' : '#008844');
            ctx.fillStyle = crystalGradient;
            ctx.beginPath();
            ctx.moveTo(x + size/2, y);
            ctx.lineTo(x + size, y + size/2);
            ctx.lineTo(x + size/2, y + size);
            ctx.lineTo(x, y + size/2);
            ctx.closePath();
            ctx.fill();

            // Блеск с анимацией
            ctx.fillStyle = isRare ? '#FF88FF' : '#88FFCC';
            const blinkSize = size / 4 + Math.sin(Date.now() / 300) * 2;
            ctx.beginPath();
            ctx.moveTo(x + size/2, y + blinkSize);
            ctx.lineTo(x + size/1.5, y + size/2);
            ctx.lineTo(x + size/2, y + size/1.5);
            ctx.lineTo(x + size/3, y + size/2);
            ctx.closePath();
            ctx.fill();
        }

        function drawMeteor(x, y, size, isAsteroid = false) {
            // Основной метеорит с текстурой
            const meteorGradient = ctx.createRadialGradient(x + size/2, y + size/2, 0, x + size/2, y + size/2, size/2);
            meteorGradient.addColorStop(0, isAsteroid ? '#A52A2A' : '#888888');
            meteorGradient.addColorStop(1, isAsteroid ? '#8B0000' : '#444444');
            ctx.fillStyle = meteorGradient;
            ctx.beginPath();
            ctx.arc(x + size/2, y + size/2, size/2, 0, Math.PI * 2);
            ctx.fill();

            // Кратеры
            ctx.fillStyle = isAsteroid ? '#CD5C5C' : '#666666';
            ctx.beginPath();
            ctx.arc(x + size/3, y + size/3, size/6, 0, Math.PI * 2);
            ctx.arc(x + size/1.5, y + size/1.7, size/7, 0, Math.PI * 2);
            ctx.arc(x + size/2.5, y + size/1.3, size/5, 0, Math.PI * 2);
            if (isAsteroid) {
                ctx.arc(x + size/4, y + size/1.5, size/8, 0, Math.PI * 2);
            }
            ctx.fill();

            // Огненный хвост с анимацией
            const tailLength = 15 + Math.sin(Date.now() / 200) * 5;
            const gradient = ctx.createLinearGradient(x + size/2, y + size, x + size/2, y + size + tailLength);
            gradient.addColorStop(0, isAsteroid ? '#FFD700' : '#FF4400');
            gradient.addColorStop(0.5, isAsteroid ? '#FFA500' : '#FFAA00');
            gradient.addColorStop(1, 'transparent');
            
            ctx.fillStyle = gradient;
            ctx.beginPath();
            ctx.moveTo(x + size/3, y + size);
            ctx.lineTo(x + size/1.5, y + size);
            ctx.lineTo(x + size/2, y + size + tailLength);
            ctx.closePath();
            ctx.fill();
        }

        function drawBonus(x, y, size, type = 'shield') {
            // Основной бонус
            const bonusColor = type === 'shield' ? '#4A4AFF' : '#FFAA00'; // Ускорение - оранжевый
            ctx.strokeStyle = bonusColor;
            ctx.lineWidth = 3;
            ctx.beginPath();
            ctx.arc(x + size/2, y + size/2, size/2, 0, Math.PI * 2);
            ctx.stroke();

            // Внутренние круги с анимацией
            const innerRadius = size/3 + Math.sin(Date.now() / 400) * 2;
            ctx.strokeStyle = type === 'shield' ? '#8888FF' : '#FFCC66';
            ctx.lineWidth = 2;
            ctx.beginPath();
            ctx.arc(x + size/2, y + size/2, innerRadius, 0, Math.PI * 2);
            ctx.stroke();

            ctx.strokeStyle = type === 'shield' ? '#AAAAFF' : '#FFE066';
            ctx.lineWidth = 1;
            ctx.beginPath();
            ctx.arc(x + size/2, y + size/2, innerRadius / 1.5, 0, Math.PI * 2);
            ctx.stroke();

            // Центральная иконка
            ctx.fillStyle = bonusColor;
            ctx.font = 'bold 16px Arial';
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';
            ctx.fillText(type === 'shield' ? 'S' : '>', x + size/2, y + size/2);
            ctx.textAlign = 'left';
            ctx.textBaseline = 'alphabetic';
        }

        function drawObject(obj) {
            switch(obj.type) {
                case 'crystal':
                    drawCrystal(obj.x, obj.y, obj.width);
                    break;
                case 'rare_crystal':
                    drawCrystal(obj.x, obj.y, obj.width, true);
                    break;
                case 'meteor':
                    drawMeteor(obj.x, obj.y, obj.width);
                    break;
                case 'asteroid':
                    drawMeteor(obj.x, obj.y, obj.width, true);
                    break;
                case 'shield_bonus':
                    drawBonus(obj.x, obj.y, obj.width, 'shield');
                    break;
                case 'speed_bonus':
                    drawBonus(obj.x, obj.y, obj.width, 'speed');
                    break;
            }
        }

        function drawFloatingScores() {
            ctx.font = '16px "Press Start 2P"';
            ctx.textAlign = 'center';
            
            for (let i = floatingScores.length - 1; i >= 0; i--) {
                const fs = floatingScores[i];
                ctx.fillStyle = `rgba(0, 255, 128, ${fs.alpha})`;
                ctx.font = `${fs.size}px "Press Start 2P"`; // Анимация размера
                ctx.fillText(fs.text, fs.x, fs.y);

                fs.y += fs.vy;
                fs.alpha -= 0.01; // Медленнее fade
                fs.size += 0.2;
                fs.vy -= 0.05; // Замедление подъема

                if (fs.alpha <= 0) {
                    floatingScores.splice(i, 1);
                }
            }
            ctx.textAlign = 'left';
        }

        // --- Функции Управления Игрой ---
        function resizeCanvas() {
            canvas.width = window.innerWidth > 400 ? 400 : window.innerWidth;
            canvas.height = window.innerHeight > 600 ? 600 : window.innerHeight;

            ship.x = (canvas.width - ship.width) / 2;
            ship.y = canvas.height - ship.height - 30;

            controlsDiv.style.maxWidth = canvas.width + 'px';
            createStars();
        }

        function startGame() {
            initAudio();
            if (currentGameState === GAME_STATE.PLAYING) return;

            hideAllScreens();
            pauseButton.style.display = 'block';
            controlsDiv.style.display = 'flex';
            currentGameState = GAME_STATE.PLAYING;
            score = 0;
            lives = 3;
            level = 1;
            objects = [];
            difficulty = 1;
            shieldActive = false;
            shieldTimer = 0;
            speedBoostActive = false;
            speedBoostTimer = 0;
            hitFlashTimer = 0;
            scoreElement.textContent = 'ОЧКИ: 0';
            livesElement.textContent = 'ЖИЗНИ: 3';
            levelElement.textContent = 'УРОВЕНЬ: 1';
            ship.x = (canvas.width - ship.width) / 2;
            ship.y = canvas.height - ship.height - 30;
            ship.speed = SHIP_SPEED_BASE;

            if (animationFrameId) cancelAnimationFrame(animationFrameId);
            gameLoop();
        }

        function pauseGame() {
            if (currentGameState === GAME_STATE.PLAYING) {
                currentGameState = GAME_STATE.PAUSED;
                cancelAnimationFrame(animationFrameId);
                showScreen(pauseScreen);
                pauseButton.style.display = 'none';
                controlsDiv.style.display = 'none';
            }
        }

        function resumeGame() {
            if (currentGameState === GAME_STATE.PAUSED) {
                hideAllScreens();
                pauseButton.style.display = 'block';
                controlsDiv.style.display = 'flex';
                currentGameState = GAME_STATE.PLAYING;
                gameLoop();
            }
        }

        function gameOver() {
            currentGameState = GAME_STATE.GAME_OVER;
            cancelAnimationFrame(animationFrameId);
            finalScoreDisplay.textContent = 'ФИНАЛЬНЫЙ СЧЕТ: ' + score;
            finalLevelDisplay.textContent = 'УРОВЕНЬ: ' + level;
            showScreen(gameOverScreen);
            pauseButton.style.display = 'none';
            controlsDiv.style.display = 'none';
            shieldProgress.style.display = 'none';

            if (tg.initDataUnsafe && tg.initDataUnsafe.user) {
                submitScoreButton.style.display = 'block';
            } else {
                submitScoreButton.style.display = 'none';
            }
            playSound(200, 500, 'sawtooth'); // Звук поражения
        }

        function restartGame() {
            hideAllScreens();
            startGame();
        }

        function submitScore() {
            if (tg.CloudStorage && tg.initDataUnsafe && tg.initDataUnsafe.user) {
                const userId = tg.initDataUnsafe.user.id;
                const scoreKey = `user_score_${userId}`;

                tg.CloudStorage.getItem(scoreKey, (error, currentHighScore) => {
                    if (error) {
                        console.error('CloudStorage getItem error:', error);
                        return;
                    }

                    const currentScoreValue = parseInt(currentHighScore || '0');

                    if (score > currentScoreValue) {
                        tg.CloudStorage.setItem(scoreKey, String(score), (error, success) => {
                            if (error) {
                                console.error('CloudStorage setItem error:', error);
                            } else if (success) {
                                tg.showAlert(`НОВЫЙ РЕКОРД: ${score}!`);
                            }
                        });
                    } else {
                        tg.showAlert(`ВАШ СЧЕТ: ${score}. РЕКОРД: ${currentHighScore}`);
                    }
                });
            } else {
                tg.showAlert('Невозможно отправить рекорд');
            }
        }

        function hideAllScreens() {
            startScreen.style.display = 'none';
            gameOverScreen.style.display = 'none';
            pauseScreen.style.display = 'none';
        }

        function showScreen(screenElement) {
            screenElement.style.display = 'flex';
        }

        // --- Улучшенная Игровая Логика ---
        function createObject() {
            const types = ['crystal', 'rare_crystal', 'shield_bonus', 'speed_bonus', 'meteor', 'asteroid'];
            const weights = [0.5, 0.1, 0.08, 0.07, 0.2, 0.05]; // Баланс

            let rand = Math.random();
            let cumulativeWeight = 0;
            let selectedType = types[0];

            for (let i = 0; i < types.length; i++) {
                cumulativeWeight += weights[i];
                if (rand < cumulativeWeight) {
                    selectedType = types[i];
                    break;
                }
            }

            let objWidth, objHeight, objSpeed;
            switch (selectedType) {
                case 'crystal':
                    objWidth = CRYSTAL_SIZE; objHeight = CRYSTAL_SIZE; objSpeed = OBJECT_SPEED_CRYSTAL;
                    break;
                case 'rare_crystal':
                    objWidth = RARE_CRYSTAL_SIZE; objHeight = RARE_CRYSTAL_SIZE; objSpeed = OBJECT_SPEED_RARE_CRYSTAL;
                    break;
                case 'shield_bonus':
                case 'speed_bonus':
                    objWidth = BONUS_SIZE; objHeight = BONUS_SIZE; objSpeed = OBJECT_SPEED_BONUS;
                    break;
                case 'meteor':
                    objWidth = METEOR_SIZE; objHeight = METEOR_SIZE; objSpeed = OBJECT_SPEED_METEOR;
                    break;
                case 'asteroid':
                    objWidth = ASTEROID_SIZE; objHeight = ASTEROID_SIZE; objSpeed = OBJECT_SPEED_ASTEROID;
                    break;
            }

            // Добавляем легкую кривизну траектории
            const vx = (Math.random() - 0.5) * 1; // Легкое горизонтальное движение

            objects.push({
                x: Math.random() * (canvas.width - objWidth),
                y: -objHeight,
                vx: vx,
                type: selectedType,
                width: objWidth,
                height: objHeight,
                speed: objSpeed * difficulty
            });
        }

        function updateGameLogic() {
            // Движение корабля
            if (keys['ArrowLeft'] || keys['a'] || keys['KeyA'] || leftButton.isPressed) ship.x -= ship.speed;
            if (keys['ArrowRight'] || keys['d'] || keys['KeyD'] || rightButton.isPressed) ship.x += ship.speed;

            // Ограничение движения корабля
            ship.x = Math.max(0, Math.min(canvas.width - ship.width, ship.x));

            // Увеличение уровня
            if (score >= level * LEVEL_UP_SCORE) {
                level++;
                difficulty += 0.2;
                levelElement.textContent = 'УРОВЕНЬ: ' + level;
                tg.showAlert(`УРОВЕНЬ ${level}! Сложность увеличена!`);
                playSound(800, 200); // Звук уровня
            }

            // Щит
            if (shieldActive) {
                shieldTimer--;
                shieldFill.style.width = `${(shieldTimer / SHIELD_DURATION_FRAMES) * 100}%`;
                if (shieldTimer <= 0) {
                    shieldActive = false;
                    shieldProgress.style.display = 'none';
                }
            }

            // Ускорение
            if (speedBoostActive) {
                speedBoostTimer--;
                if (speedBoostTimer <= 0) {
                    speedBoostActive = false;
                    ship.speed = SHIP_SPEED_BASE;
                }
            }

            // Мигание при попадании
            if (hitFlashTimer > 0) {
                hitFlashTimer--;
            }

            // Создание объектов
            if (Math.random() < OBJECT_SPAWN_RATE_BASE * difficulty) createObject();

            // Обновление объектов и проверка столкновений
            for (let i = objects.length - 1; i >= 0; i--) {
                const obj = objects[i];
                obj.y += obj.speed;
                obj.x += obj.vx; // Добавлено горизонтальное движение

                // Ограничение для объектов (чтобы не уходили за экран)
                if (obj.x < 0 || obj.x > canvas.width - obj.width) {
                    obj.vx = -obj.vx;
                }

                // Удаление объектов за экраном
                if (obj.y > canvas.height) {
                    objects.splice(i, 1);
                    continue;
                }

                // Проверка столкновения
                if (obj.x < ship.x + ship.width &&
                    obj.x + obj.width > ship.x &&
                    obj.y < ship.y + ship.height &&
                    obj.y + obj.height > ship.y) {

                    objects.splice(i, 1);

                    if (obj.type === 'crystal' || obj.type === 'rare_crystal') {
                        const points = obj.type === 'crystal' ? SCORE_CRYSTAL : SCORE_RARE_CRYSTAL;
                        score += points;
                        scoreElement.textContent = 'ОЧКИ: ' + score;
                        floatingScores.push({
                            x: ship.x + ship.width / 2,
                            y: ship.y,
                            text: `+${points}`,
                            alpha: 1,
                            vy: -2,
                            size: 16
                        });
                        playSound(600, 100); // Звук сбора
                    } else if (obj.type === 'shield_bonus') {
                        shieldActive = true;
                        shieldTimer = SHIELD_DURATION_FRAMES;
                        shieldProgress.style.display = 'block';
                        shieldFill.style.width = '100%';
                        tg.showAlert('ЩИТ АКТИВИРОВАН!');
                        playSound(700, 150);
                    } else if (obj.type === 'speed_bonus') {
                        speedBoostActive = true;
                        speedBoostTimer = SPEED_BOOST_DURATION_FRAMES;
                        ship.speed = SHIP_SPEED_BASE * 1.5;
                        tg.showAlert('УСКОРЕНИЕ АКТИВИРОВАНО!');
                        playSound(900, 150);
                    } else if (obj.type === 'meteor' || obj.type === 'asteroid') {
                        const damage = obj.type === 'meteor' ? 1 : 2; // Астероид наносит больше урона
                        if (!shieldActive) {
                            lives -= damage;
                            livesElement.textContent = 'ЖИЗНИ: ' + lives;
                            hitFlashTimer = HIT_FLASH_DURATION_FRAMES;
                            playSound(300, 200, 'sawtooth'); // Звук удара
                            if (lives <= 0) {
                                gameOver();
                                return;
                            }
                        } else {
                            shieldActive = false;
                            shieldTimer = 0;
                            shieldProgress.style.display = 'none';
                            tg.showAlert('ЩИТ ПОГЛОТИЛ УДАР!');
                            playSound(400, 150);
                        }
                    }
                }
            }
        }

        function gameLoop() {
            if (currentGameState === GAME_STATE.PLAYING) {
                updateGameLogic();
            }

            // Отрисовка
            ctx.fillStyle = '#000011';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            
            drawStars();
            
            for (const obj of objects) {
                drawObject(obj);
            }
            
            drawShip();
            drawFloatingScores();

            animationFrameId = requestAnimationFrame(gameLoop);
        }

        // --- Обработчики Событий ---
        document.addEventListener('keydown', (e) => {
            if (currentGameState === GAME_STATE.PLAYING) {
                keys[e.key] = true;
                if (e.key === 'Escape') {
                    pauseGame();
                }
            } else if (e.key === 'Escape' && currentGameState === GAME_STATE.PAUSED) {
                resumeGame();
            }
        });
        
        document.addEventListener('keyup', (e) => {
            keys[e.key] = false;
        });

        // Тач управление
        canvas.addEventListener('touchstart', (e) => {
            if (currentGameState !== GAME_STATE.PLAYING) return;
            e.preventDefault();
            touchStartX = e.touches[0].clientX - canvas.getBoundingClientRect().left;
        }, { passive: false });

        canvas.addEventListener('touchmove', (e) => {
            if (currentGameState !== GAME_STATE.PLAYING) return;
            e.preventDefault();
            const touchX = e.touches[0].clientX - canvas.getBoundingClientRect().left;
            ship.x += (touchX - touchStartX) * TOUCH_MOVE_SENSITIVITY;
            touchStartX = touchX;
        }, { passive: false });

        // Кнопки управления
        leftButton.addEventListener('touchstart', (e) => {
            e.preventDefault();
            leftButton.isPressed = true;
        }, { passive: false });
        leftButton.addEventListener('touchend', () => { leftButton.isPressed = false; });
        leftButton.addEventListener('touchcancel', () => { leftButton.isPressed = false; });

        rightButton.addEventListener('touchstart', (e) => {
            e.preventDefault();
            rightButton.isPressed = true;
        }, { passive: false });
        rightButton.addEventListener('touchend', () => { rightButton.isPressed = false; });
        rightButton.addEventListener('touchcancel', () => { rightButton.isPressed = false; });

        // Инициализация
        resizeCanvas();
        window.addEventListener('resize', resizeCanvas);
        showScreen(startScreen);
    </script>
</body>
</html>
